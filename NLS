<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Queue Optimizer - Hệ Thống Tối Ưu Hàng Đợi Siêu Thị</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes walk {
            0% { transform: translateX(100px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        .customer-icon {
            animation: walk 0.5s ease-out;
        }
        .server-busy {
            background-color: #ef4444;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-lg">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-robot text-3xl"></i>
                <h1 class="text-2xl font-bold uppercase tracking-tight">AI Queue Optimizer</h1>
            </div>
            <div class="text-sm bg-indigo-800 px-4 py-2 rounded-full mt-2 md:mt-0">
                Mô phỏng M/M/1 & M/M/2 Hệ thống Hàng đợi Siêu thị
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 lg:p-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left Panel: Input & AI Training -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Data Input Section -->
                <section class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-indigo-700">
                        <i class="fas fa-database"></i> Nhập Dữ Liệu Thực Tế
                    </h2>
                    <p class="text-sm text-slate-500 mb-4">Nhập số lượng khách đến trong 5 khung giờ gần nhất để AI ước lượng λ.</p>
                    
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-slate-600">Khung giờ 1 (khách)</label>
                                <input type="number" id="h1" value="15" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-600">Khung giờ 2 (khách)</label>
                                <input type="number" id="h2" value="22" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-slate-600">Khung giờ 3 (khách)</label>
                                <input type="number" id="h3" value="35" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-600">Khung giờ 4 (khách)</label>
                                <input type="number" id="h4" value="45" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-600">Khung giờ 5 (khách - hiện tại)</label>
                            <input type="number" id="h5" value="50" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <hr class="my-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Tốc độ phục vụ (μ) - Khách/giờ/quầy</label>
                            <input type="number" id="mu_val" value="30" class="w-full border p-2 rounded bg-indigo-50 font-bold text-indigo-700">
                        </div>
                        <button onclick="estimateAndSimulate()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-200 mt-4">
                            PHÂN TÍCH & TỐI ƯU
                        </button>
                    </div>
                </section>

                <!-- AI Forecast Result -->
                <section id="ai-result-card" class="bg-indigo-900 text-white p-6 rounded-xl shadow-md hidden">
                    <h2 class="text-xl font-bold mb-2 flex items-center gap-2">
                        <i class="fas fa-brain"></i> Dự báo AI (Next Hour)
                    </h2>
                    <div class="flex justify-between items-end border-b border-indigo-700 pb-4 mb-4">
                        <div>
                            <span class="text-indigo-300 text-sm">λ dự báo (khách/h)</span>
                            <div class="text-3xl font-bold" id="forecast-lambda">0</div>
                        </div>
                        <div class="text-right">
                            <span class="text-indigo-300 text-sm">Xu hướng</span>
                            <div class="text-lg font-semibold text-green-400" id="forecast-trend">Tăng trưởng</div>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Độ tin cậy:</span>
                            <span class="font-mono">94.2%</span>
                        </div>
                        <div class="flex justify-between text-yellow-400 font-bold">
                            <span>Khuyến nghị:</span>
                            <span id="ai-recommendation">Mở 2 Quầy</span>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Panel: Simulation & Metrics -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- Performance Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500">
                        <div class="text-slate-500 text-xs font-bold uppercase">Thời gian chờ TB (Wq)</div>
                        <div class="text-2xl font-bold mt-1" id="stat-wq">0.0 phút</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow border-l-4 border-purple-500">
                        <div class="text-slate-500 text-xs font-bold uppercase">Độ dài hàng đợi (Lq)</div>
                        <div class="text-2xl font-bold mt-1" id="stat-lq">0.0 khách</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow border-l-4 border-orange-500">
                        <div class="text-slate-500 text-xs font-bold uppercase">Hiệu suất quầy (ρ)</div>
                        <div class="text-2xl font-bold mt-1" id="stat-rho">0%</div>
                    </div>
                </div>

                <!-- Visualization Area -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-desktop"></i> Mô phỏng Hàng đợi Trực quan
                    </h2>
                    
                    <div class="space-y-12 py-8 relative">
                        <!-- Queue Line 1 -->
                        <div class="flex items-center gap-4">
                            <div class="w-24 font-bold text-slate-500 text-sm">QUẦY 1</div>
                            <div id="counter-1" class="w-16 h-16 bg-indigo-100 border-4 border-indigo-500 rounded-lg flex items-center justify-center relative">
                                <i class="fas fa-cash-register text-indigo-600 text-2xl"></i>
                                <span class="absolute -top-3 -right-3 bg-indigo-600 text-white text-[10px] px-2 py-0.5 rounded-full">ACTIVE</span>
                            </div>
                            <div id="queue-container-1" class="flex flex-row-reverse gap-2 flex-grow overflow-hidden h-12 items-center px-4 bg-slate-50 rounded-full border border-dashed border-slate-300">
                                <!-- Customers will appear here -->
                            </div>
                        </div>

                        <!-- Queue Line 2 -->
                        <div id="row-counter-2" class="flex items-center gap-4 opacity-30">
                            <div class="w-24 font-bold text-slate-500 text-sm">QUẦY 2</div>
                            <div id="counter-2" class="w-16 h-16 bg-slate-100 border-4 border-slate-300 rounded-lg flex items-center justify-center relative">
                                <i class="fas fa-cash-register text-slate-400 text-2xl"></i>
                                <span id="status-label-2" class="absolute -top-3 -right-3 bg-slate-400 text-white text-[10px] px-2 py-0.5 rounded-full">OFFLINE</span>
                            </div>
                            <div id="queue-container-2" class="flex flex-row-reverse gap-2 flex-grow overflow-hidden h-12 items-center px-4 bg-slate-50 rounded-full border border-dashed border-slate-300">
                                <!-- Customers will appear here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comparison Chart -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                        <h3 class="text-lg font-bold mb-4">So sánh M/M/1 vs M/M/2</h3>
                        <canvas id="comparisonChart" height="200"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                        <h3 class="text-lg font-bold mb-4">Phân tích tải theo λ</h3>
                        <canvas id="loadChart" height="200"></canvas>
                    </div>
                </div>

                <!-- Optimization Table -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 overflow-x-auto">
                    <h3 class="text-lg font-bold mb-4">Bảng Tối Ưu Hóa Khung Giờ</h3>
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr class="border-b bg-slate-50">
                                <th class="p-3">Khung Giờ</th>
                                <th class="p-3">Dự báo λ</th>
                                <th class="p-3">Mô hình</th>
                                <th class="p-3">Chờ TB (Wq)</th>
                                <th class="p-3">Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="optimization-tbody">
                            <!-- Rows generated by JS -->
                            <tr class="border-b">
                                <td class="p-3 text-slate-400 italic" colspan="5 text-center">Nhấn "Phân tích" để xem dữ liệu...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-slate-800 text-slate-400 py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="mb-2 font-bold text-slate-200">Siêu Thị Smart Queue AI Engine v1.0</p>
            <p class="text-sm">Ứng dụng xây dựng trên mô hình toán học Erlang-C cho hệ thống M/M/s.</p>
        </div>
    </footer>

    <script>
        let comparisonChart, loadChart;

        // Queue Math Engine
        const QueueMath = {
            // M/M/1
            mm1: (lambda, mu) => {
                if (lambda >= mu) return { rho: 1, lq: Infinity, wq: Infinity, l: Infinity, w: Infinity };
                const rho = lambda / mu;
                const l = lambda / (mu - lambda);
                const w = 1 / (mu - lambda);
                const lq = (rho * rho) / (1 - rho);
                const wq = rho / (mu - lambda);
                return { rho, l, w, lq, wq };
            },
            // M/M/2
            mm2: (lambda, mu) => {
                const s = 2;
                const rho = lambda / (s * mu);
                if (rho >= 1) return { rho: 1, lq: Infinity, wq: Infinity, l: Infinity, w: Infinity };
                
                const r = lambda / mu;
                const p0 = 1 / (1 + r + (Math.pow(r, 2) / (2 * (1 - rho))));
                const lq = (p0 * Math.pow(r, 2) * rho) / (2 * Math.pow(1 - rho, 2));
                const wq = lq / lambda;
                const w = wq + (1 / mu);
                const l = lambda * w;
                
                return { rho, l, w, lq, wq };
            }
        };

        // AI Logic: Simple Linear Trend Estimation
        function aiEstimateLambda() {
            const h = [
                parseInt(document.getElementById('h1').value),
                parseInt(document.getElementById('h2').value),
                parseInt(document.getElementById('h3').value),
                parseInt(document.getElementById('h4').value),
                parseInt(document.getElementById('h5').value)
            ];
            
            // Calculate trend using simple linear regression slope
            const n = h.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            for(let i=0; i<n; i++) {
                sumX += (i+1);
                sumY += h[i];
                sumXY += (i+1) * h[i];
                sumX2 += (i+1) * (i+1);
            }
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            // Forecast for next step (index 6)
            const forecast = Math.max(0, Math.round(slope * (n + 1) + intercept));
            const trend = slope > 0 ? "Tăng" : "Giảm";
            
            return { forecast, trend };
        }

        function estimateAndSimulate() {
            const { forecast, trend } = aiEstimateLambda();
            const mu = parseFloat(document.getElementById('mu_val').value);
            
            // Update UI
            document.getElementById('ai-result-card').classList.remove('hidden');
            document.getElementById('forecast-lambda').innerText = forecast;
            document.getElementById('forecast-trend').innerText = trend + (trend === "Tăng" ? " ↑" : " ↓");
            document.getElementById('forecast-trend').className = trend === "Tăng" ? "text-lg font-semibold text-red-400" : "text-lg font-semibold text-green-400";

            // Decisions
            const res1 = QueueMath.mm1(forecast, mu);
            const res2 = QueueMath.mm2(forecast, mu);
            
            let optimalS = 1;
            let currentRes = res1;
            
            // Strategy: If M/M/1 waiting time > 2 minutes (0.033 hours) or utilization > 85%, open 2nd counter
            if (res1.wq > 0.033 || res1.rho > 0.85) {
                optimalS = 2;
                currentRes = res2;
                document.getElementById('ai-recommendation').innerText = "Mở 2 Quầy (Cần thiết)";
                document.getElementById('ai-recommendation').className = "text-red-400 font-bold";
            } else {
                document.getElementById('ai-recommendation').innerText = "Duy trì 1 Quầy";
                document.getElementById('ai-recommendation').className = "text-green-400 font-bold";
            }

            // Update Statistics
            document.getElementById('stat-wq').innerText = (currentRes.wq * 60).toFixed(1) + " phút";
            document.getElementById('stat-lq').innerText = currentRes.lq.toFixed(1) + " khách";
            document.getElementById('stat-rho').innerText = Math.min(100, Math.round(currentRes.rho * 100)) + "%";

            updateSimulationUI(optimalS, currentRes.lq);
            updateCharts(forecast, mu);
            updateTable(forecast, mu, optimalS, currentRes);
        }

        function updateSimulationUI(s, lq) {
            const container1 = document.getElementById('queue-container-1');
            const container2 = document.getElementById('queue-container-2');
            const counter2Row = document.getElementById('row-counter-2');
            const counter2Box = document.getElementById('counter-2');
            const statusLabel2 = document.getElementById('status-label-2');

            container1.innerHTML = '';
            container2.innerHTML = '';

            // Visual limit
            const displayLq = Math.min(Math.round(lq), 15);
            
            if (s === 1) {
                counter2Row.classList.add('opacity-30');
                counter2Box.classList.replace('border-indigo-500', 'border-slate-300');
                counter2Box.classList.replace('bg-indigo-100', 'bg-slate-100');
                statusLabel2.innerText = "OFFLINE";
                statusLabel2.className = "absolute -top-3 -right-3 bg-slate-400 text-white text-[10px] px-2 py-0.5 rounded-full";
                
                for(let i=0; i<displayLq; i++) {
                    container1.innerHTML += `<i class="fas fa-user-tie text-indigo-500 text-xl customer-icon" style="animation-delay: ${i*0.1}s"></i>`;
                }
            } else {
                counter2Row.classList.remove('opacity-30');
                counter2Box.classList.replace('border-slate-300', 'border-indigo-500');
                counter2Box.classList.replace('bg-slate-100', 'bg-indigo-100');
                statusLabel2.innerText = "ACTIVE";
                statusLabel2.className = "absolute -top-3 -right-3 bg-indigo-600 text-white text-[10px] px-2 py-0.5 rounded-full";
                
                // Split queue
                for(let i=0; i<Math.ceil(displayLq/2); i++) {
                    container1.innerHTML += `<i class="fas fa-user-tie text-indigo-500 text-xl customer-icon" style="animation-delay: ${i*0.1}s"></i>`;
                }
                for(let i=0; i<Math.floor(displayLq/2); i++) {
                    container2.innerHTML += `<i class="fas fa-user-tie text-indigo-500 text-xl customer-icon" style="animation-delay: ${i*0.1}s"></i>`;
                }
            }
        }

        function updateCharts(lambda, mu) {
            const lambdas = Array.from({length: 10}, (_, i) => Math.round(lambda * (0.5 + i * 0.15)));
            const mm1Wqs = lambdas.map(l => {
                const r = QueueMath.mm1(l, mu);
                return r.wq === Infinity ? 60 : Math.min(60, r.wq * 60);
            });
            const mm2Wqs = lambdas.map(l => {
                const r = QueueMath.mm2(l, mu);
                return r.wq === Infinity ? 60 : Math.min(60, r.wq * 60);
            });

            if (comparisonChart) comparisonChart.destroy();
            const ctx1 = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: lambdas,
                    datasets: [
                        { label: 'M/M/1 (1 Quầy)', data: mm1Wqs, borderColor: '#6366f1', tension: 0.3 },
                        { label: 'M/M/2 (2 Quầy)', data: mm2Wqs, borderColor: '#10b981', tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { tooltip: { mode: 'index', intersect: false } },
                    scales: { y: { title: { display: true, text: 'Thời gian chờ (Phút)' }, beginAtZero: true } }
                }
            });

            if (loadChart) loadChart.destroy();
            const ctx2 = document.getElementById('loadChart').getContext('2d');
            loadChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Tải hiện tại', 'Dự báo tiếp theo'],
                    datasets: [{
                        label: 'Số khách trong hệ thống (L)',
                        data: [
                            QueueMath.mm1(parseInt(document.getElementById('h5').value), mu).l,
                            QueueMath.mm2(lambda, mu).l
                        ],
                        backgroundColor: ['#6366f1', '#f59e0b']
                    }]
                },
                options: { responsive: true }
            });
        }

        function updateTable(lambda, mu, s, currentRes) {
            const tbody = document.getElementById('optimization-tbody');
            const now = new Date();
            const hours = ["08:00", "09:00", "10:00", "11:00", "12:00", "13:00"];
            
            tbody.innerHTML = '';
            
            // Current simulated hour
            const tr = document.createElement('tr');
            tr.className = "border-b bg-indigo-50 font-medium";
            tr.innerHTML = `
                <td class="p-3">Tiếp theo</td>
                <td class="p-3">${lambda}</td>
                <td class="p-3">M/M/${s}</td>
                <td class="p-3">${(currentRes.wq * 60).toFixed(1)}m</td>
                <td class="p-3"><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">TỐI ƯU</span></td>
            `;
            tbody.appendChild(tr);

            // Mock other hours
            [1.2, 0.8, 1.5].forEach((factor, i) => {
                const mockL = Math.round(lambda * factor);
                const mockS = mockL > mu * 0.8 ? 2 : 1;
                const mockRes = mockS === 2 ? QueueMath.mm2(mockL, mu) : QueueMath.mm1(mockL, mu);
                
                const tr2 = document.createElement('tr');
                tr2.className = "border-b text-slate-600";
                tr2.innerHTML = `
                    <td class="p-3">Khung +${i+2}h</td>
                    <td class="p-3">${mockL}</td>
                    <td class="p-3">M/M/${mockS}</td>
                    <td class="p-3">${mockRes.wq === Infinity ? '>60' : (mockRes.wq * 60).toFixed(1)}m</td>
                    <td class="p-3"><span class="bg-slate-100 text-slate-500 px-2 py-1 rounded text-xs">DỰ KIẾN</span></td>
                `;
                tbody.appendChild(tr2);
            });
        }

        // Initialize
        window.onload = () => {
            estimateAndSimulate();
        };
    </script>
</body>
</html>
